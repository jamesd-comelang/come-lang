module main

import net.tls      // TLS primitives
import net.http     // HTTP request/response handling
import std          // printing, etc.

server() 
{
    // 1. Create a TLS context (cert & key)
    net_tls_context tls_ctx = {
        .cert_file = "server.crt",
        .key_file = "server.key",
    }

    // 2. Listen on port 443 with the TLS context
    var tls_listener = net.tls.listen("0.0.0.0", 443, tls_ctx)

    // 3. For every new TLS connection, wrap it in an HTTP session
    tls_listener.on(ACCEPT) {
        var conn = tls_listener.accept()   // raw TLS socket

        // Create an HTTP session that will speak over this socket
        var http = net.http.new()
        http.attach(conn)                   // bind the HTTP layer to the TLS socket

        // 4. Handle each HTTP request as it arrives
        http.req.on(READ_DONE) {
            var resp = http.resp

            // Very small “Hello, world” handler
            resp.send(
                "HTTP/1.1 200 OK\r\n"
                "Content-Type: text/plain\r\n"
                "Content-Length: 13\r\n\r\n"
                "Hello, world"
            )
        }
    }
}

main() 
{
    server()
}
